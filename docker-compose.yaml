version: '3.8'

services:
  # 蓝色 Redis（旧版本 4.0.14）
  redis-blue:
    image: redis:4.0.14
    container_name: redis-blue
    ports:
      - "6379:6379"
    volumes:
      - ./redis-blue/redis.conf:/usr/local/etc/redis/redis.conf
      - ./data/redis-blue:/data
    command: redis-server /usr/local/etc/redis/redis.conf
    networks:
      - redis-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # 绿色 Redis（新版本 7.0.15）
  redis-green:
    image: redis:7.0.15
    container_name: redis-green
    ports:
      - "6380:6379"
    volumes:
      - ./redis-green/redis.conf:/usr/local/etc/redis/redis.conf
      - ./data/redis-green:/data
    command: redis-server /usr/local/etc/redis/redis.conf
    networks:
      - redis-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # Redis-Shake 数据同步工具
  redis-shake:
    build:
      context: ./redis-shake
      dockerfile: Dockerfile
    container_name: redis-shake
    volumes:
      - ./redis-shake/shake.toml:/app/shake.toml
      - ./data/redis-shake:/app/data
      - ./redis-shake/logs:/app/logs
    networks:
      - redis-network
    depends_on:
      redis-blue:
        condition: service_healthy
      redis-green:
        condition: service_healthy
    profiles:
      - sync  # 使用 profile 控制，默认不启动
    restart: "no"

networks:
  redis-network:
    driver: bridge

volumes:
  redis-blue-data:
  redis-green-data:
