# Redis 4.0.10 â†’ Valkey 7.2 è¿ç§» - æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤


## ğŸ“‹ æµ‹è¯•æ­¥éª¤æ¸…å•

### æ­¥éª¤ 0: æ¸…ç†ç¯å¢ƒï¼ˆå¦‚æœä¹‹å‰è¿è¡Œè¿‡ï¼‰

```bash
cd /Users/huanghansheng/go/src/redis-blue-green

# ä½¿ç”¨è„šæœ¬æ¸…ç†ï¼ˆæ¨èï¼‰
./scripts/stop-all.sh

# æˆ–æ‰‹åŠ¨æ¸…ç†
docker-compose --profile sync down
```

**âš ï¸ é‡è¦**ï¼šå¿…é¡»ä½¿ç”¨ `--profile sync` å‚æ•°ï¼Œå¦åˆ™ redis-shake å®¹å™¨ä¸ä¼šè¢«åˆ é™¤ï¼

```bash
# âŒ é”™è¯¯ - ä¸ä¼šåˆ é™¤ redis-shake
docker-compose down

# âœ… æ­£ç¡® - ä¼šåˆ é™¤æ‰€æœ‰å®¹å™¨ï¼ˆåŒ…æ‹¬ redis-shakeï¼‰
docker-compose --profile sync down
```

æ¸…ç†æ•°æ®ï¼ˆå¯é€‰ï¼‰ï¼š
```bash
rm -rf data/ redis-shake/logs/
```

---

## æ­¥éª¤ 1: å¯åŠ¨ä¸¤ä¸ª Redis å®ä¾‹

```bash
./scripts/start-redis.sh
```


---

## æ­¥éª¤ 2: å‘ Redis 4.0 å¯¼å…¥æµ‹è¯•æ•°æ®

```bash
./scripts/test-data.sh
```

---

## æ­¥éª¤ 3: å¯åŠ¨ redis-shake è¿›è¡ŒåŒæ­¥

```bash
./scripts/start-sync.sh
```

### æ£€æŸ¥å¯åŠ¨æ—¥å¿—

```bash
docker logs redis-shake
```

**é¢„æœŸæ—¥å¿—å†…å®¹**ï¼š
```
[INFO] load config from file: shake.toml
[INFO] create SyncStandaloneReader: redis-blue:6379
[INFO] create RedisStandaloneWriter: redis-green:6379
[INFO] start syncing...
[INFO] syncing aof  â† è¿™ä¸ªå¾ˆé‡è¦ï¼è¡¨ç¤ºä½¿ç”¨ PSYNC
```

**âœ… æ£€æŸ¥ç‚¹**: æ—¥å¿—ä¸­çœ‹åˆ° `syncing aof`

---

## æ­¥éª¤ 4: æŸ¥çœ‹åŒæ­¥è¿›åº¦

```bash
# å®æ—¶æ—¥å¿—ï¼ˆCtrl+C é€€å‡ºï¼‰
docker logs -f redis-shake
```

**å…³é”®æ—¥å¿—**ï¼š
- `syncing aof` - **æ­£åœ¨ä½¿ç”¨ PSYNC å¢é‡åŒæ­¥**
- `diff=[0]` - åŒæ­¥å»¶è¿Ÿä¸º 0

### æ£€æŸ¥åŒæ­¥çŠ¶æ€

```bash
./scripts/check-sync.sh
```

æˆ–æ‰‹åŠ¨æ£€æŸ¥ï¼š

```bash
# æŸ¥çœ‹ Valkey çš„é”®æ•°é‡
docker exec redis-green redis-cli DBSIZE
# åº”è¯¥å’Œ Redis 4.0 ä¸€æ ·: (integer) 1504

# éªŒè¯å…·ä½“æ•°æ®
docker exec redis-green redis-cli GET "user:100:name"
# åº”è¯¥æ˜¾ç¤º: "User_100"

docker exec redis-green redis-cli HGETALL "user:100:profile"
# åº”è¯¥å’Œ Redis 4.0 çš„æ•°æ®ä¸€è‡´
```

**âœ… æ£€æŸ¥ç‚¹**: é”®æ•°é‡ä¸€è‡´

---

## æ­¥éª¤ 5: æµ‹è¯•å¢é‡åŒæ­¥ï¼ˆPSYNC çš„å…³é”®ï¼ï¼‰

### 5.1 å‘ Redis 4.0 å†™å…¥æ–°æ•°æ®

```bash
# å†™å…¥ä¸€ä¸ªå¸¦æ—¶é—´æˆ³çš„é”®
docker exec redis-blue redis-cli SET "test_psync_$(date +%s)" "å¢é‡åŒæ­¥æµ‹è¯•_$(date '+%H:%M:%S')"

# å†™å…¥ä¸€ä¸ªå“ˆå¸Œ
docker exec redis-blue redis-cli HSET "test_hash" field1 "value1" field2 "value2"

# å†™å…¥ä¸€ä¸ªåˆ—è¡¨
docker exec redis-blue redis-cli LPUSH "test_list" "item1" "item2" "item3"
```

**é¢„æœŸè¾“å‡º**ï¼š
```
OK
3
3
```

### 5.2 ç­‰å¾… 2-3 ç§’è®©æ•°æ®åŒæ­¥

```bash
echo "ç­‰å¾…åŒæ­¥..."
sleep 3
```

### 5.3 éªŒè¯ Valkey æ˜¯å¦æ”¶åˆ°æ•°æ®

```bash
# æŸ¥çœ‹æ‰€æœ‰æµ‹è¯•é”®
docker exec redis-green redis-cli KEYS "test_*"
# åº”è¯¥æ˜¾ç¤ºåˆšæ‰åˆ›å»ºçš„é”®

# è·å–å­—ç¬¦ä¸²é”®çš„å€¼
TEST_KEY=$(docker exec redis-blue redis-cli KEYS "test_psync_*" | head -1 | tr -d '\r')
echo "æµ‹è¯•é”®: $TEST_KEY"
echo "Redis 4.0 çš„å€¼: $(docker exec redis-blue redis-cli GET "$TEST_KEY")"
echo "Valkey 7.2 çš„å€¼: $(docker exec redis-green redis-cli GET "$TEST_KEY")"

# è·å–å“ˆå¸Œçš„å€¼
echo ""
echo "=== å“ˆå¸Œæ•°æ®å¯¹æ¯” ==="
echo "Redis 4.0:"
docker exec redis-blue redis-cli HGETALL "test_hash"
echo "Valkey 7.2:"
docker exec redis-green redis-cli HGETALL "test_hash"

# è·å–åˆ—è¡¨çš„å€¼
echo ""
echo "=== åˆ—è¡¨æ•°æ®å¯¹æ¯” ==="
echo "Redis 4.0:"
docker exec redis-blue redis-cli LRANGE "test_list" 0 -1
echo "Valkey 7.2:"
docker exec redis-green redis-cli LRANGE "test_list" 0 -1
```

### 5.4 æŸ¥çœ‹ redis-shake æ—¥å¿—ç¡®è®¤åŒæ­¥

```bash
docker logs redis-shake | tail -n 5
```

**ä½ åº”è¯¥çœ‹åˆ°**ï¼š
```
[INFO] read_count=[1507], read_ops=[3.00], ...  â† æ³¨æ„è¿™é‡Œå¢åŠ äº† 3 ä¸ªæ“ä½œ
```

**âœ… æ£€æŸ¥ç‚¹**:
- Valkey 7.2 èƒ½è¯»åˆ°åˆšæ‰å†™å…¥çš„æ•°æ®
- ä¸¤è¾¹çš„å€¼å®Œå…¨ä¸€è‡´
- redis-shake æ—¥å¿—æ˜¾ç¤º `read_ops` å¢åŠ 

---

## æ­¥éª¤ 6: å‹åŠ›æµ‹è¯• - æ‰¹é‡å†™å…¥

### 6.1 æ‰¹é‡å†™å…¥æ•°æ®

```bash
echo "å¼€å§‹æ‰¹é‡å†™å…¥ 5000 æ¡æ•°æ®..."
docker exec redis-blue bash -c '
for i in {10001..15000}; do
    redis-cli SET "batch:$i" "value_$i" > /dev/null
    if [ $((i % 1000)) -eq 0 ]; then
        echo "  å·²å†™å…¥ $((i - 10000)) æ¡..."
    fi
done
echo "âœ… æ‰¹é‡å†™å…¥å®Œæˆ"
'
```

### 6.2 ç­‰å¾…åŒæ­¥

```bash
echo "ç­‰å¾…åŒæ­¥..."
sleep 5
```

### 6.3 å¯¹æ¯”é”®æ•°é‡

```bash
echo "=== æ‰¹é‡å†™å…¥åçš„æ•°æ®å¯¹æ¯” ==="
BLUE_COUNT=$(docker exec redis-blue redis-cli DBSIZE | tr -d '\r')
GREEN_COUNT=$(docker exec redis-green redis-cli DBSIZE | tr -d '\r')

echo "Redis 4.0: $BLUE_COUNT ä¸ªé”®"
echo "Valkey 7.2: $GREEN_COUNT ä¸ªé”®"

if [ "$BLUE_COUNT" -eq "$GREEN_COUNT" ]; then
    echo "âœ… é”®æ•°é‡ä¸€è‡´ï¼åŒæ­¥æˆåŠŸï¼"
else
    echo "âš ï¸  å·®å¼‚: $((BLUE_COUNT - GREEN_COUNT)) ä¸ªé”®"
fi
```

### 6.4 éªŒè¯å…·ä½“æ•°æ®

```bash
# éšæœºéªŒè¯å‡ ä¸ªé”®
for i in 10500 12000 14500; do
    KEY="batch:$i"
    BLUE_VAL=$(docker exec redis-blue redis-cli GET "$KEY")
    GREEN_VAL=$(docker exec redis-green redis-cli GET "$KEY")

    if [ "$BLUE_VAL" = "$GREEN_VAL" ]; then
        echo "âœ… $KEY ä¸€è‡´: $BLUE_VAL"
    else
        echo "âŒ $KEY ä¸ä¸€è‡´ï¼"
    fi
done
```

**âœ… æ£€æŸ¥ç‚¹**: å¤§æ‰¹é‡å†™å…¥åï¼Œæ•°æ®ä»ç„¶èƒ½å¿«é€ŸåŒæ­¥ä¸”ä¸€è‡´

---

## æ­¥éª¤ 7: æŸ¥çœ‹ Redis 4.0 çš„å¤åˆ¶ä¿¡æ¯

### 7.1 æŸ¥çœ‹ replication ä¿¡æ¯

```bash
docker exec redis-blue redis-cli INFO replication
```

**ä½ ä¼šçœ‹åˆ°ç±»ä¼¼è¾“å‡º**ï¼š
```
role:master
connected_slaves:1
slave0:ip=172.x.x.x,port=xxxxx,state=online,offset=12345,lag=0
```

**è§£è¯»**ï¼š
- `role:master` - Redis 4.0 æ˜¯ä¸»åº“
- `connected_slaves:1` - æœ‰ 1 ä¸ªä»åº“è¿æ¥ï¼ˆå°±æ˜¯ redis-shakeï¼ï¼‰
- `state=online` - ä»åº“åœ¨çº¿
- `offset=12345` - åŒæ­¥åç§»é‡
- `lag=0` - å»¶è¿Ÿä¸º 0

**è¿™è¯æ˜ redis-shake æˆåŠŸä¼ªè£…æˆäº† Redis çš„ä»åº“ï¼**

### 7.2 æŸ¥çœ‹ Valkey çš„è§’è‰²

```bash
docker exec redis-green redis-cli INFO replication
```

**è¾“å‡º**ï¼š
```
role:master
connected_slaves:0
```

**è§£è¯»**ï¼š
- Valkey 7.2 ä»ç„¶æ˜¯ä¸»åº“
- redis-shake åªæ˜¯ä½œä¸ºå®¢æˆ·ç«¯å†™å…¥æ•°æ®ï¼Œä¸æ˜¯ä»åº“

---

## æ­¥éª¤ 8: åœæ­¢æœåŠ¡

```bash
./scripts/stop-all.sh

# å®Œå…¨æ¸…ç†æ•°æ®ï¼ˆå¯é€‰ï¼‰
rm -rf data/ redis-shake/logs/
```

---

## ğŸ” å…³é”®è§‚å¯Ÿç‚¹æ€»ç»“

### 1. redis-shake ä½¿ç”¨ PSYNC çš„è¯æ®

**æ—¥å¿—ä¸­çœ‹åˆ°**ï¼š
```
[INFO] syncing aof
```

**è¯´æ˜**ï¼š
- `syncing aof` = æ­£åœ¨ä½¿ç”¨ AOF å¢é‡åŒæ­¥
- æ ¹æ®åä¸ºäº‘æ–‡æ¡£ï¼Œ`sync_aof = true` ä¼šè‡ªåŠ¨ä½¿ç”¨ **PSYNC åè®®**

### 2. Redis 4.0 çš„ replication ä¿¡æ¯

```
connected_slaves:1
slave0:ip=xxx, state=online, lag=0
```

**è¯´æ˜**ï¼š
- redis-shake ä¼ªè£…æˆäº† Redis ä»åº“
- é€šè¿‡ PSYNC åè®®æ¥æ”¶ä¸»åº“çš„å†™æ“ä½œ

### 3. å¢é‡åŒæ­¥å®æ—¶æ€§

**æµ‹è¯•ç»“æœ**ï¼š
- å†™å…¥æ–°æ•°æ®å 2-3 ç§’å†…åŒæ­¥å®Œæˆ
- `diff=[0]` è¡¨ç¤ºæ— å»¶è¿Ÿ
- å¤§æ‰¹é‡å†™å…¥ä¹Ÿèƒ½å¿«é€ŸåŒæ­¥

### 4. æ•°æ®ä¸€è‡´æ€§

**éªŒè¯ç‚¹**ï¼š
- é”®æ•°é‡ä¸€è‡´
- å…·ä½“å€¼ä¸€è‡´
- å„ç§æ•°æ®ç±»å‹éƒ½æ­£ç¡®åŒæ­¥

---

## ğŸ“Š æµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] æ­¥éª¤ 1: Redis 4.0 å’Œ Valkey 7.2 éƒ½èƒ½ PING é€š âœ…
- [ ] æ­¥éª¤ 2: Redis 4.0 æœ‰ 1500+ ä¸ªé”® âœ…
- [ ] æ­¥éª¤ 3: redis-shake å¯åŠ¨æˆåŠŸï¼Œæ—¥å¿—æ˜¾ç¤º `syncing aof` âœ…
- [ ] æ­¥éª¤ 4: Valkey 7.2 é”®æ•°é‡å’Œ 4.0 ä¸€è‡´ âœ…
- [ ] æ­¥éª¤ 5: æ–°å†™å…¥çš„æ•°æ®èƒ½åœ¨ 2-3 ç§’å†…åŒæ­¥ âœ…
- [ ] æ­¥éª¤ 6: æ‰¹é‡å†™å…¥ 5000 æ¡æ•°æ®åä»ç„¶åŒæ­¥æ­£å¸¸ âœ…
- [ ] æ­¥éª¤ 7: Redis 4.0 æ˜¾ç¤ºæœ‰ 1 ä¸ªä»åº“è¿æ¥ âœ…
- [ ] æ­¥éª¤ 8: check-sync.sh æ˜¾ç¤ºæ•°æ®ä¸€è‡´ âœ…

å…¨éƒ¨é€šè¿‡å³è¡¨ç¤º **PSYNC å¢é‡åŒæ­¥å·¥ä½œæ­£å¸¸**ï¼

---

## ğŸ’¡ é¢å¤–å®éªŒ

### å®éªŒ 1: æµ‹è¯•åˆ é™¤æ“ä½œ

```bash
# åœ¨ Redis 4.0 åˆ é™¤ä¸€ä¸ªé”®
docker exec redis-blue redis-cli DEL "user:100:name"

# ç­‰å¾…åŒæ­¥
sleep 2

# æ£€æŸ¥ Valkey 7.2
docker exec redis-green redis-cli EXISTS "user:100:name"
# åº”è¯¥è¿”å›: (integer) 0 è¡¨ç¤ºå·²åˆ é™¤
```

### å®éªŒ 2: æµ‹è¯•è¿‡æœŸé”®

```bash
# åœ¨ Redis 4.0 è®¾ç½®ä¸€ä¸ª 10 ç§’è¿‡æœŸçš„é”®
docker exec redis-blue redis-cli SETEX "expire_test" 10 "will_expire"

# ç«‹å³æ£€æŸ¥ Valkey 7.2
docker exec redis-green redis-cli GET "expire_test"
# åº”è¯¥èƒ½è¯»åˆ°å€¼

# ç­‰å¾… 10 ç§’
sleep 11

# å†æ¬¡æ£€æŸ¥
docker exec redis-green redis-cli GET "expire_test"
# åº”è¯¥è¿”å›: (nil) è¡¨ç¤ºå·²è¿‡æœŸ
```

### å®éªŒ 3: æµ‹è¯•äº‹åŠ¡

```bash
# åœ¨ Redis 4.0 æ‰§è¡Œäº‹åŠ¡
docker exec redis-blue redis-cli <<EOF
MULTI
SET tx_key1 value1
SET tx_key2 value2
SET tx_key3 value3
EXEC
EOF

# æ£€æŸ¥ Valkey 7.2
docker exec redis-green redis-cli MGET tx_key1 tx_key2 tx_key3
# åº”è¯¥è¿”å›æ‰€æœ‰å€¼
```

---

## ğŸ¯ å®Œæˆï¼

ç°åœ¨ä½ å¯ä»¥æŒ‰ç…§è¿™äº›æ­¥éª¤è‡ªå·±æ“ä½œå’ŒéªŒè¯äº†ï¼

æ¯ä¸€æ­¥éƒ½æœ‰ï¼š
- âœ… æ˜ç¡®çš„å‘½ä»¤
- âœ… é¢„æœŸçš„è¾“å‡º
- âœ… æ£€æŸ¥ç‚¹è¯´æ˜

å»ºè®®æ‰“å¼€ä¸¤ä¸ªç»ˆç«¯çª—å£ï¼š
- **ç»ˆç«¯ 1**: æ‰§è¡Œå‘½ä»¤
- **ç»ˆç«¯ 2**: å®æ—¶æŸ¥çœ‹æ—¥å¿— `docker logs -f redis-shake`

ç¥æµ‹è¯•é¡ºåˆ©ï¼ğŸ‰
